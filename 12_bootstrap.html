
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Bootstrap Sampling &#8212; Elements of Data Science</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '12_bootstrap';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Hypothesis Testing" href="13_hypothesis.html" />
    <link rel="prev" title="Resampling" href="11_resampling.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
  
    <p class="title logo__title">Elements of Data Science</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    Elements of Data Science
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapters</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_variables.html">Variables and Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_times.html">Times and Places</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_arrays.html">Lists and Arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_loops.html">Loops and Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_dictionaries.html">Dictionaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_plotting.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_dataframes.html">DataFrames and Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_distributions.html">Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_relationships.html">Relationships</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_regression.html">Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="11_resampling.html">Resampling</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Bootstrap Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="13_hypothesis.html">Hypothesis Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="14_outro.html">Further Reading</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="resample_logit.html">Resampling and Logistic Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="anderson.html">Never Test for Normality</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/AllenDowney/ElementsOfDataScience" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/12_bootstrap.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Bootstrap Sampling</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-average-income">Estimating Average Income</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-percentiles">Estimating Percentiles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrapping">Bootstrapping</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#working-with-bigger-data">Working with Bigger Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#weighted-bootstrapping">Weighted Bootstrapping</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#correlation-and-regression">Correlation and Regression</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations-of-bootstrapping">Limitations of Bootstrapping</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resampling-with-kde">Resampling with KDE</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p>Printed copies of <em>Elements of Data Science</em> are available now, with a <strong>full color interior</strong>.</p>
<p>From July 17 to July 31, <a class="reference external" href="https://www.lulu.com/shop/allen-downey/elements-of-data-science/paperback/product-9dyrwn.html">get 20% off at Lulu.com</a>.</p>
<section class="tex2jax_ignore mathjax_ignore" id="bootstrap-sampling">
<h1>Bootstrap Sampling<a class="headerlink" href="#bootstrap-sampling" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/AllenDowney/ElementsOfDataScience/blob/v1/12_bootstrap.ipynb">Click here to run this notebook on Colab</a>.</p>
<div class="cell tag_remove-print docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">exists</span>

<span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>

        <span class="n">local</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloaded &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">local</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">filename</span>

<span class="n">download</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/AllenDowney/ElementsOfDataScience/v1/utils.py&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">utils</span>
</pre></div>
</div>
</div>
</div>
<p>In the previous chapter we used resampling to compute sampling distributions, which quantify the variability in an estimate due to random sampling.</p>
<p>In this chapter, we’ll use data from the General Social Survey (GSS) to estimate average income and the 10th percentile of income.
We’ll see that the resampling method we used in the previous chapter works for the average but not for the 10th percentile.
To solve this problem, we’ll use another kind of resampling, called bootstrapping.</p>
<p>Then we’ll use bootstrapping to compute sampling distributions for correlations and the parameters of linear regression.
Finally, I’ll point out a problem with bootstrap resampling when there are not enough different values in a dataset, and a way to solve it with KDE resampling.</p>
<section id="estimating-average-income">
<h2>Estimating Average Income<a class="headerlink" href="#estimating-average-income" title="Link to this heading">#</a></h2>
<p>As a first example, we’ll use data from the General Social Survey to estimate average family income.
We’ll work with an extract that contains just the columns we need, as we did in Chapter 8.
Instructions for downloading the extract are in the notebook for this chapter.</p>
<p>We can load the data like this and display the first few rows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">gss</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="s1">&#39;gss_extract_2022.hdf&#39;</span><span class="p">,</span> <span class="s1">&#39;gss&#39;</span><span class="p">)</span>
<span class="n">gss</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>id</th>
      <th>age</th>
      <th>educ</th>
      <th>degree</th>
      <th>sex</th>
      <th>gunlaw</th>
      <th>grass</th>
      <th>realinc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1972</td>
      <td>1</td>
      <td>23.0</td>
      <td>16.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>18951.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1972</td>
      <td>2</td>
      <td>70.0</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>24366.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1972</td>
      <td>3</td>
      <td>48.0</td>
      <td>12.0</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>24366.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1972</td>
      <td>4</td>
      <td>27.0</td>
      <td>17.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>30458.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1972</td>
      <td>5</td>
      <td>61.0</td>
      <td>12.0</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>50763.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The column <code class="docutils literal notranslate"><span class="pre">realinc</span></code> records family income, converted to 1986 dollars.
The following figure uses the Seaborn function <code class="docutils literal notranslate"><span class="pre">kdeplot</span></code> to show the distribution of family income.
The argument <code class="docutils literal notranslate"><span class="pre">cut=0</span></code> cuts off the curve so it doesn’t extend beyond the observed minimum and maximum values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">gss</span><span class="p">[</span><span class="s1">&#39;realinc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;GSS data&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Family income ($1000s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;PDF&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of income&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1db7cfb9789a656de26f76f6c0a0ffd2d35df8fed3d37a8013e5326e0b265a59.png" src="_images/1db7cfb9789a656de26f76f6c0a0ffd2d35df8fed3d37a8013e5326e0b265a59.png" />
</div>
</div>
<p>The distribution of income is skewed to the right; most household incomes are less than $60,000, but a few are substantially higher.
Here are the mean and standard deviation of the reported incomes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_realinc</span> <span class="o">=</span> <span class="n">gss</span><span class="p">[</span><span class="s1">&#39;realinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">std_realinc</span> <span class="o">=</span> <span class="n">gss</span><span class="p">[</span><span class="s1">&#39;realinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mean_realinc</span><span class="p">,</span> <span class="n">std_realinc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>32537.399981032493 30883.22609399141
</pre></div>
</div>
</div>
</div>
<p>The average family income in this sample is $32,537.
But if we ran the GSS survey again, the average might be higher or lower.
To see how much it might vary, we can use this function from the previous chapter to simulate the sampling process.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">simulate_sample_mean</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sample</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">simulate_sample_mean</span></code> takes as parameters the sample size and the mean and standard deviation.
It generates a sample from a normal distribution and returns the mean.</p>
<p>Before we call this function, we have to count the number of valid responses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_realinc</span> <span class="o">=</span> <span class="n">gss</span><span class="p">[</span><span class="s1">&#39;realinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">n_realinc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>64912
</pre></div>
</div>
</div>
</div>
<p>Now, if we call <code class="docutils literal notranslate"><span class="pre">simulate_sample_mean</span></code> once, we get a single value from the sampling distribution of the mean.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulate_sample_mean</span><span class="p">(</span><span class="n">n_realinc</span><span class="p">,</span> <span class="n">mean_realinc</span><span class="p">,</span> <span class="n">std_realinc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>32573.420195135117
</pre></div>
</div>
</div>
</div>
<p>If we call it many times, we get a random sample from the sampling distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span> <span class="o">=</span> <span class="p">[</span><span class="n">simulate_sample_mean</span><span class="p">(</span><span class="n">n_realinc</span><span class="p">,</span> <span class="n">mean_realinc</span><span class="p">,</span> <span class="n">std_realinc</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1001</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s what the sampling distribution looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Family income (1986 $)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;PDF&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sampling distribution of mean income&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ffde614265cdf2eff562d567461d70d70d350163cfa5ff89aaaa83167ead10dd.png" src="_images/ffde614265cdf2eff562d567461d70d70d350163cfa5ff89aaaa83167ead10dd.png" />
</div>
</div>
<p>This distribution shows how much we would expect the observed mean to vary if we ran the GSS survey again.
We’ll use the following function to summarize the sampling distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
    <span class="n">SE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
    <span class="n">CI90</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">est</span><span class="p">,</span> <span class="n">SE</span><span class="p">,</span> <span class="n">CI90</span><span class="p">]</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Estimate&#39;</span><span class="p">,</span> <span class="s1">&#39;SE&#39;</span><span class="p">,</span> <span class="s1">&#39;CI90&#39;</span><span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">data</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summary1</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">summary1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Estimate</th>
      <th>SE</th>
      <th>CI90</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th></th>
      <td>32533.8</td>
      <td>120.7</td>
      <td>[32331.4, 32724.2]</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The result shows the mean of the sampling distribution, the standard error, and a 90% confidence interval.
The mean of the sampling distribution is close to the mean of the data, as we expect.
The standard error quantifies the width of the sampling distribution, which is about $121.
Informally, that’s how much we would expect the sample mean to change if we ran the survey again.
And if we ran the survey many times and computed the average income each time, we would expect 90% of the results to fall in the range from 32,331 to 32,724.</p>
<p>In this section, we used a normal distribution to simulate the sampling process.
The normal distribution is not a particularly good model for the distribution of income, but it works well enough for this example, and the results are reasonable.
In the next section we’ll see an example where the normal distribution is not good enough and the results are not reasonable.
Then we’ll see how to fix the problem.</p>
</section>
<section id="estimating-percentiles">
<h2>Estimating Percentiles<a class="headerlink" href="#estimating-percentiles" title="Link to this heading">#</a></h2>
<p>Suppose that, instead of estimating the average income, we want to estimate the 10th percentile.
Computing percentiles of income is often relevant to discussions of income inequality.</p>
<p>To compute the 10th percentile of the data, we can use the Pandas method <code class="docutils literal notranslate"><span class="pre">quantile</span></code>, which is similar to the NumPy function <code class="docutils literal notranslate"><span class="pre">percentile</span></code>, except that it drops <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values.
Also, the parameter of <code class="docutils literal notranslate"><span class="pre">quantile</span></code> is a probability between 0 and 1, rather than a percentage between 0 and 100.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gss</span><span class="p">[</span><span class="s1">&#39;realinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5730.0
</pre></div>
</div>
</div>
</div>
<p>The 10th percentile of the sample is $5730, but if we collected another sample, the result might be higher or lower.
To see how much it would vary, we can use the following function to simulate the sampling process: <code class="docutils literal notranslate"><span class="pre">simulate_sample_percentile</span></code> generates a sample from a normal distribution and returns the 10th percentile.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simulate_sample_percentile</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If we call it many times, the result is a sample from the sampling distribution of the 10th percentile.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t2</span> <span class="o">=</span> <span class="p">[</span><span class="n">simulate_sample_percentile</span><span class="p">(</span><span class="n">n_realinc</span><span class="p">,</span> <span class="n">mean_realinc</span><span class="p">,</span> <span class="n">std_realinc</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1001</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s what that sampling distribution looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Family income (1986 $)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;PDF&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sampling distribution of the 10th percentile&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d1a5aea7a5e960583399e5b737ed79ed43dea2e004db81343cb44d91e011856b.png" src="_images/d1a5aea7a5e960583399e5b737ed79ed43dea2e004db81343cb44d91e011856b.png" />
</div>
</div>
<p>We can see that something has gone wrong.
All of the values in the sampling distribution are negative, even though no one in the sample reported a negative income.
To see what happened, let’s look at the distribution of reported incomes again compared to the normal distribution with the same mean and standard deviation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>

<span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="n">ys</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">mean_realinc</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">std_realinc</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">gss</span><span class="p">[</span><span class="s1">&#39;realinc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;GSS data&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.7&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;normal model&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Family income ($1000s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;PDF&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of income&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/06afff0e6862bb01258dc12893fa80313b4b0a6703c3dbc9555cc9b3d9109531.png" src="_images/06afff0e6862bb01258dc12893fa80313b4b0a6703c3dbc9555cc9b3d9109531.png" />
</div>
</div>
<p>The problem is that the normal model extends past the lower bound of the observed values, so it doesn’t produce sensible results.
Fortunately there is a simple alternative that is more robust: bootstrapping.</p>
</section>
<section id="bootstrapping">
<h2>Bootstrapping<a class="headerlink" href="#bootstrapping" title="Link to this heading">#</a></h2>
<p>Bootstrapping is a kind of resampling, based on the framework we saw in the previous chapter:</p>
<p><img alt="" src="https://github.com/AllenDowney/ElementsOfDataScience/raw/v1/figs/resampling.png" /></p>
<p>The idea is that we treat the original sample as if it were the entire population, and simulate the sampling process by choosing random rows with replacement.
<code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> provides a method called <code class="docutils literal notranslate"><span class="pre">sample</span></code> we can use to select a random sample of the rows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bootstrapped</span> <span class="o">=</span> <span class="n">gss</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_realinc</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">bootstrapped</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(64912, 9)
</pre></div>
</div>
</div>
</div>
<p>The argument <code class="docutils literal notranslate"><span class="pre">n=n_realinc</span></code> means that the bootstrapped sample has the same size as the original.
<code class="docutils literal notranslate"><span class="pre">replace=True</span></code> means that sampling is done with replacement – that is, the same row can be chosen more than once.
To see how many times each row appears in the bootstrapped sample, we can use <code class="docutils literal notranslate"><span class="pre">value_counts</span></code> and the <code class="docutils literal notranslate"><span class="pre">id</span></code> column, which contains a unique identifier for each respondent.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">repeats</span> <span class="o">=</span> <span class="n">bootstrapped</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">repeats</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>id
90     55
373    49
322    47
190    46
975    46
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Several of the rows appear more than 40 times.
Since some rows appear many times, other rows don’t appear at all.  To see how many, we can use <code class="docutils literal notranslate"><span class="pre">set</span></code> subtraction to count the values of <code class="docutils literal notranslate"><span class="pre">id</span></code> that appear in the original dataset but not the bootstrapped sample.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unused</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gss</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">bootstrapped</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="nb">len</span><span class="p">(</span><span class="n">unused</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>228
</pre></div>
</div>
</div>
</div>
<p>Now we can use bootstrapping to generate a sampling distribution.
For example, the following function takes a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>, generates a bootstrapped sample, and returns the average income.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bootstrap_mean</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
    <span class="n">bootstrapped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bootstrapped</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>If we run it many times, we get a sample from the sampling distribution of the mean.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t3</span> <span class="o">=</span> <span class="p">[</span><span class="n">bootstrap_mean</span><span class="p">(</span><span class="n">gss</span><span class="p">,</span> <span class="s1">&#39;realinc&#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1001</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s a summary of the results, compared to the results based on the normal model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summary3</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">t3</span><span class="p">)</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">summary1</span><span class="p">,</span> <span class="n">summary3</span><span class="p">])</span>
<span class="n">table</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;normal model&#39;</span><span class="p">,</span> <span class="s1">&#39;bootstrapping&#39;</span><span class="p">]</span>
<span class="n">table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Estimate</th>
      <th>SE</th>
      <th>CI90</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>normal model</th>
      <td>32533.80</td>
      <td>120.70</td>
      <td>[32331.4, 32724.2]</td>
    </tr>
    <tr>
      <th>bootstrapping</th>
      <td>32540.97</td>
      <td>120.44</td>
      <td>[32345.43, 32735.15]</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The results from bootstrap sampling are consistent with the results based on the normal model.
Now let’s see what happens when we estimate the 10th percentile.
The following function generates a bootstrapped sample and returns the 10th percentile.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bootstrap_income_percentile</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">bootstrapped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bootstrapped</span><span class="p">[</span><span class="s1">&#39;realinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can use it to generate a sample from the sampling distribution of the 10th percentile.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t4</span> <span class="o">=</span> <span class="p">[</span><span class="n">bootstrap_income_percentile</span><span class="p">(</span><span class="n">gss</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1001</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Here are the results from bootstrapping compared to the results from the normal model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summary2</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
<span class="n">summary4</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">t4</span><span class="p">)</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">summary2</span><span class="p">,</span> <span class="n">summary4</span><span class="p">])</span>
<span class="n">table</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;normal model&#39;</span><span class="p">,</span> <span class="s1">&#39;bootstrapping&#39;</span><span class="p">]</span>
<span class="n">table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Estimate</th>
      <th>SE</th>
      <th>CI90</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>normal model</th>
      <td>-7036.41</td>
      <td>206.15</td>
      <td>[-7377.72, -6709.54]</td>
    </tr>
    <tr>
      <th>bootstrapping</th>
      <td>5687.12</td>
      <td>91.42</td>
      <td>[5512.5, 5827.5]</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The results from bootstrapping are more sensible – the mean of the sampling distribution and the bounds of the confidence interval are positive and consistent with the 10th percentile of the data.</p>
<p>In general, bootstrapping is robust – that is, it works well with many different distributions and many different statistics.
However, at the end of the chapter, we’ll see one example where it fails.</p>
</section>
<section id="working-with-bigger-data">
<h2>Working with Bigger Data<a class="headerlink" href="#working-with-bigger-data" title="Link to this heading">#</a></h2>
<p>As sample size increases, errors due to random sampling get smaller.
To demonstrate this effect, we’ll use data from the Behavioral Risk Factor Surveillance System (BRFSS) to estimate the average height for men in the United States.</p>
<p>First, let’s read the 2021 data, which I have stored in an HDF file.
Instructions for downloading it are in the notebook for this chapter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">brfss</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="s1">&#39;brfss_2021.hdf&#39;</span><span class="p">,</span> <span class="s1">&#39;brfss&#39;</span><span class="p">)</span>
<span class="n">brfss</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(438693, 10)
</pre></div>
</div>
</div>
</div>
<p>This dataset contains 438,693 rows, one for each respondent, and 10 columns, one for each variable in the extract.
Here are the first few rows.</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brfss</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_solution tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>HTM4</th>
      <th>WTKG3</th>
      <th>_SEX</th>
      <th>_AGEG5YR</th>
      <th>_VEGESU1</th>
      <th>_INCOMG1</th>
      <th>_LLCPWT</th>
      <th>_HTM4G10</th>
      <th>AGE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>150.0</td>
      <td>32.66</td>
      <td>2</td>
      <td>11.0</td>
      <td>2.14</td>
      <td>3.0</td>
      <td>744.745531</td>
      <td>140.0</td>
      <td>72.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>168.0</td>
      <td>NaN</td>
      <td>2</td>
      <td>10.0</td>
      <td>1.28</td>
      <td>NaN</td>
      <td>299.137394</td>
      <td>160.0</td>
      <td>67.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>165.0</td>
      <td>77.11</td>
      <td>2</td>
      <td>11.0</td>
      <td>0.71</td>
      <td>2.0</td>
      <td>587.862986</td>
      <td>160.0</td>
      <td>72.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>163.0</td>
      <td>88.45</td>
      <td>2</td>
      <td>9.0</td>
      <td>1.65</td>
      <td>5.0</td>
      <td>1099.621570</td>
      <td>160.0</td>
      <td>62.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>180.0</td>
      <td>93.44</td>
      <td>1</td>
      <td>12.0</td>
      <td>2.58</td>
      <td>2.0</td>
      <td>1711.825870</td>
      <td>170.0</td>
      <td>77.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">HTM4</span></code> column contains the respondents’ heights in centimeters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">height</span> <span class="o">=</span> <span class="n">brfss</span><span class="p">[</span><span class="s1">&#39;HTM4&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>To select male respondents, we’ll use the <code class="docutils literal notranslate"><span class="pre">SEX</span></code> column to make a Boolean <code class="docutils literal notranslate"><span class="pre">Series</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">male</span> <span class="o">=</span> <span class="p">(</span><span class="n">brfss</span><span class="p">[</span><span class="s1">&#39;_SEX&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">male</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>203760
</pre></div>
</div>
</div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">count</span></code> to count the number of male respondents with valid height data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_height</span> <span class="o">=</span> <span class="n">height</span><span class="p">[</span><span class="n">male</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">n_height</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>193701
</pre></div>
</div>
</div>
</div>
<p>Here is the mean and standard deviation of these values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_height</span> <span class="o">=</span> <span class="n">height</span><span class="p">[</span><span class="n">male</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">std_height</span> <span class="o">=</span> <span class="n">height</span><span class="p">[</span><span class="n">male</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">mean_height</span><span class="p">,</span> <span class="n">std_height</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(178.14807357731763, 7.987083970017878)
</pre></div>
</div>
</div>
</div>
<p>The average height for men in the U.S. is about 178 cm.
To see how precise this estimate is, we can use bootstrapping to generate values from the sampling distribution.
To reduce computation time, I set the number of iterations to 201.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t5</span> <span class="o">=</span> <span class="p">[</span><span class="n">bootstrap_mean</span><span class="p">(</span><span class="n">brfss</span><span class="p">[</span><span class="n">male</span><span class="p">],</span> <span class="s1">&#39;HTM4&#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">201</span><span class="p">)]</span>

<span class="n">summarize</span><span class="p">(</span><span class="n">t5</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Estimate</th>
      <th>SE</th>
      <th>CI90</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th></th>
      <td>178.148</td>
      <td>0.018</td>
      <td>[178.121, 178.176]</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Because the sample size is so large, the standard error is small and the confidence interval is narrow.
This result suggests that our estimate is very precise, which is true in the sense that the error due to random sampling is small.</p>
<p>But there are other sources of error.
For example, the heights and weights in this dataset are self-reported, so they are vulnerable to <strong>social desirability bias</strong>, which is the tendency of people to represent themselves in a positive light.</p>
<p>It’s also possible that there are errors in recording the data.
In a previous year of the BRFSS, there are a suspicious number of heights recorded as 60 or 61 centimeters.
I suspect that many of them are six feet tall, or six feet and one inch, and something went wrong in recording the data.</p>
<p>And that brings us to the point of this example:</p>
<blockquote>
<div><p>With large sample sizes, variability due to random sampling is small, but with real-world data, that often means that other sources of error are bigger. So we can’t be sure that the estimate is accurate.</p>
</div></blockquote>
<p>In fact, there is another source of error in this example that we have not taken into account: oversampling.</p>
</section>
<section id="weighted-bootstrapping">
<h2>Weighted Bootstrapping<a class="headerlink" href="#weighted-bootstrapping" title="Link to this heading">#</a></h2>
<p>By design, the BRFSS oversamples some demographic groups – that is, people in some groups are more likely than others to appear in the sample.
If people in these groups are taller than others on average, or shorter, our estimated mean would not be accurate.</p>
<p>We encountered this issue in Chapter 7, where we used data from the National Survey of Family Growth (NSFG) to compute the average birth weight for babies in the United States.
In that example, we corrected for oversampling by computing a weighted mean.</p>
<p>In this example, we’ll use a different method, <strong>weighted bootstrapping</strong>, to estimate the mean and compute a confidence interval.
The BRFSS dataset includes a column, <code class="docutils literal notranslate"><span class="pre">_LLCPWT</span></code>, that contains sampling weights.
The sampling weight for each respondent is the number of people in the population they represent.
People in oversampled groups have lower sampling weights; people in undersampled groups have higher sampling weights.
Here’s what the range of values looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">brfss</span><span class="p">[</span><span class="s1">&#39;_LLCPWT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count    438693.000000
mean        560.851529
std        1136.781547
min           0.545800
25%          95.573000
50%         248.677287
75%         592.546811
max       49028.547000
Name: _LLCPWT, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The lowest sampling weight is about 0.5; the largest is about 49,000 – so that’s a very wide range!
We can take these weights into account by passing them as an argument to <code class="docutils literal notranslate"><span class="pre">sample</span></code>.
That way, the probability that any row is selected is proportional to its sampling weight.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">brfss</span><span class="p">)</span>
<span class="n">bootstrapped</span> <span class="o">=</span> <span class="n">brfss</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;_LLCPWT&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As we saw with unweighted bootstrapping, the same row can appear more than once.
To see how many times, we can use <code class="docutils literal notranslate"><span class="pre">value_counts</span></code> and the <code class="docutils literal notranslate"><span class="pre">SEQNO</span></code> column, which contains a unique identifier for each respondent.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">repeats</span> <span class="o">=</span> <span class="n">bootstrapped</span><span class="p">[</span><span class="s1">&#39;SEQNO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">repeats</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SEQNO
2021000019    144
2021001348    132
2021000044    129
2021003808    127
2021000091    124
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Some rows appear more than 100 times.
Most likely, these are the rows for people from undersampled groups, who have the highest sampling weights.</p>
<p>To see how many rows don’t appear at all, we can use <code class="docutils literal notranslate"><span class="pre">set</span></code> subtraction to count the values of <code class="docutils literal notranslate"><span class="pre">SEQNO</span></code> that appear in the original dataset but not the sample.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unused</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">brfss</span><span class="p">[</span><span class="s1">&#39;SEQNO&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">bootstrapped</span><span class="p">[</span><span class="s1">&#39;SEQNO&#39;</span><span class="p">])</span>
<span class="nb">len</span><span class="p">(</span><span class="n">unused</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14616
</pre></div>
</div>
</div>
</div>
<p>There are thousands of rows that don’t appear in this sample, but they are not dropped altogether – when we repeat this process, they will appear in other samples.</p>
<p>Now we can use weighted bootstrapping to generate values from the sampling distribution of the mean.
The following function uses <code class="docutils literal notranslate"><span class="pre">sample</span></code> and the <code class="docutils literal notranslate"><span class="pre">_LLCPWT</span></code> column to generate a bootstrapped sample, then returns the average height.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">weighted_bootstrap_mean</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;_LLCPWT&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;HTM4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>I’ll test this function with a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> that contains only male respondents.
If we run it once, we get a single value from the sampling distribution of the weighted mean.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">male_df</span> <span class="o">=</span> <span class="n">brfss</span><span class="p">[</span><span class="n">male</span><span class="p">]</span>
<span class="n">weighted_bootstrap_mean</span><span class="p">(</span><span class="n">male_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>177.569630553049
</pre></div>
</div>
</div>
</div>
<p>If we run it many times, we get a random sample from the sampling distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t6</span> <span class="o">=</span> <span class="p">[</span><span class="n">weighted_bootstrap_mean</span><span class="p">(</span><span class="n">male_df</span><span class="p">)</span> 
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">201</span><span class="p">)]</span>

<span class="n">summarize</span><span class="p">(</span><span class="n">t6</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Estimate</th>
      <th>SE</th>
      <th>CI90</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th></th>
      <td>177.541</td>
      <td>0.018</td>
      <td>[177.513, 177.573]</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The mean of the sampling distribution estimates the average height for men in the U.S., corrected for oversampling.
If we compare it to the unweighted mean we computed, it is a little lower.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t6</span><span class="p">),</span> <span class="n">mean_height</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>177.54149968876962 178.14807357731763
</pre></div>
</div>
</div>
</div>
<p>So it seems like people in the oversampled groups are taller than others, on average, by enough to bring the unweighted mean up by about half a centimeter.</p>
<p>The difference between the weighted and unweighted averages is bigger than the width of the confidence interval.
So in this example the error if we fail to correct for oversampling is bigger than variability due to random sampling.</p>
</section>
<section id="correlation-and-regression">
<h2>Correlation and Regression<a class="headerlink" href="#correlation-and-regression" title="Link to this heading">#</a></h2>
<p>Bootstrap resampling can be used to estimate other statistics and their sampling distributions.
For example, in Chapter 9 we computed the correlation between height and weight, which is about 0.47.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span> <span class="o">=</span> <span class="s1">&#39;HTM4&#39;</span><span class="p">,</span> <span class="s1">&#39;WTKG3&#39;</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">brfss</span><span class="p">[</span><span class="n">var1</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">brfss</span><span class="p">[</span><span class="n">var2</span><span class="p">])</span>
<span class="n">corr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4693981914367917
</pre></div>
</div>
</div>
</div>
<p>That correlation does not take into account oversampling.
We can correct it with this function, which generates a weighted bootstrapped sample and uses it to compute the correlation of the columns specified by <code class="docutils literal notranslate"><span class="pre">var1</span></code> and <code class="docutils literal notranslate"><span class="pre">var2</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">weighted_bootstrap_corr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;_LLCPWT&#39;</span><span class="p">)</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="n">var1</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="n">var2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">corr</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Exercise:</strong> Use this function to draw 101 values from the sampling distribution of the correlation between height and weight.
What is the mean of these values?  Is it substantially different from the correlation we computed without correcting for oversampling?
Compute the standard error and 90% confidence interval for the estimated correlation.</p>
<p><strong>Exercise:</strong> In Chapter 9 we also computed the slope of the regression line for weight as a function of height.
Here’s the result.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">linregress</span>

<span class="n">subset</span> <span class="o">=</span> <span class="n">brfss</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;WTKG3&#39;</span><span class="p">,</span> <span class="s1">&#39;HTM4&#39;</span><span class="p">])</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;HTM4&#39;</span><span class="p">],</span> <span class="n">subset</span><span class="p">[</span><span class="s1">&#39;WTKG3&#39;</span><span class="p">])</span>
<span class="n">res</span><span class="o">.</span><span class="n">slope</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9366891536604244
</pre></div>
</div>
</div>
</div>
<p>The estimated slope is 0.94 kg/cm, which means that we expect someone 1 cm taller than average to be about 0.94 kg heavier than average.</p>
<p>Write a function called <code class="docutils literal notranslate"><span class="pre">weighted_bootstrap_slope</span></code> that takes a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>, generates a weighted bootstrapped sample, runs <code class="docutils literal notranslate"><span class="pre">linregress</span></code> with height and weight, and returns the slope of the regression line.</p>
<p>Run it 101 times and collect the results.  Use the sampling distribution to compute the mean of the slope estimates, standard error, and a 90% confidence interval.</p>
</section>
<section id="limitations-of-bootstrapping">
<h2>Limitations of Bootstrapping<a class="headerlink" href="#limitations-of-bootstrapping" title="Link to this heading">#</a></h2>
<p>One limitation of bootstrapping is that it can be computationally expensive.
With small datasets, it is usually fast enough that we can generate a thousand values from the sampling distribution, which means that we can compute standard errors and confidence intervals precisely.
With larger datasets, we can cut the computation time by generating fewer values.
With 100-200 values, the standard errors we get are usually precise enough, but the bounds of the confidence intervals might be noisier.</p>
<p>The other limitation, which can be more problematic, is that bootstrap sampling does not work well with datasets that contain a small number of different values.
To demonstrate, I’ll select data from the GSS for one year, 2018:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_year</span> <span class="o">=</span> <span class="n">gss</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2018</span>
<span class="n">gss2018</span> <span class="o">=</span> <span class="n">gss</span><span class="p">[</span><span class="n">one_year</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>And use bootstrapping to generate values from the sampling distribution of the 10th percentile.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t9</span> <span class="o">=</span> <span class="p">[</span><span class="n">bootstrap_income_percentile</span><span class="p">(</span><span class="n">gss2018</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1001</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Here are the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summary9</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">t9</span><span class="p">)</span>
<span class="n">summary9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Estimate</th>
      <th>SE</th>
      <th>CI90</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th></th>
      <td>5155.46</td>
      <td>223.92</td>
      <td>[5107.5, 5107.5]</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The estimate and the standard error look plausible at first glance, but the width of the confidence interval is 0, which suggests that something has gone wrong!
The problem is that <code class="docutils literal notranslate"><span class="pre">realinc</span></code> is not really a numerical variable – it is a categorical variable in disguise.
Using <code class="docutils literal notranslate"><span class="pre">value_counts</span></code>, we can see that there are only 26 distinct values in this column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">gss2018</span><span class="p">[</span><span class="s1">&#39;realinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>26
</pre></div>
</div>
</div>
</div>
<p>The reason is that the GSS does not ask respondents to report their incomes.
Instead, it gives them a list of ranges and asks them to pick the range their income falls in.
Then GSS analysts compute the midpoint of each range and convert to 1986 dollars by adjusting for inflation.
As a result, there are only 26 distinct values for each year of the survey.
When we generate a bootstrapped sample and compute the 10th percentile, we get a small subset of them.
Here are the values that appear in our sample.</p>
<p>Details of the methodology are in available <a class="reference external" href="https://gss.norc.org/Documents/reports/methodological-reports/MR101%20Getting%20the%20Most%20Out%20of%20the%20GSS%20Income%20Measures.pdf">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">t9</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5107.5    955
5221.0      1
5448.0      1
5561.5      1
5675.0      1
5902.0      2
6015.5      1
6129.0      2
6242.5     37
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>There are a small number different values, and one of them appears more than 95% of the time.
When we compute a 90% confidence interval, this value is both the 5th and the 95th percentile.</p>
<p>Bootstrapping works well for most distributions and most statistics, but the one thing it can’t handle is lack of diversity in the data.
Fortunately, this problem can be solved.
The cause of the problem is that the data have been discretized excessively, so the solution is to smooth it.
Jittering is one option.
Another is to use kernel density estimation (KDE).</p>
</section>
<section id="resampling-with-kde">
<h2>Resampling with KDE<a class="headerlink" href="#resampling-with-kde" title="Link to this heading">#</a></h2>
<p>We have used KDE several times to estimate and plot a probability density based on a sample.
We can also use it to smooth data that have been discretized.</p>
<p>For this example, we’ll compute the logarithms of the income values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">log_realinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">gss2018</span><span class="p">[</span><span class="s1">&#39;realinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>We’ve seen that the distribution of income is skewed so the tail extends farther to the right than the left.
The logarithms of income have a more symmetric distribution that makes them work better with KDE.
Here’s what the estimated density looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">log_realinc</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Income (log10 1986 dollars)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Probability density&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Estimated distribution of income&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/32965de9819412a065e9b221e9c6f0ca1b28f3140bd5e61f1c9d6cd3f37b70e2.png" src="_images/32965de9819412a065e9b221e9c6f0ca1b28f3140bd5e61f1c9d6cd3f37b70e2.png" />
</div>
</div>
<p>To draw samples from this distribution, we’ll use a Scipy function called <code class="docutils literal notranslate"><span class="pre">gaussian_kde</span></code>, which takes the data and returns an object that represents the estimated density.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>

<span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">log_realinc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The resulting object provides a method called <code class="docutils literal notranslate"><span class="pre">resample</span></code> that draws random values from the estimated density.
As we’ve done in previous examples, we’ll generate a resampled dataset with the same size as the original – which is stored as <code class="docutils literal notranslate"><span class="pre">kde.n</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">kde</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can compute the 10th percentile and convert from a logarithm to a dollar value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5272.140381990193
</pre></div>
</div>
</div>
</div>
<p>The result is a random value from the sampling distribution of the 10th percentile.
The following function encapsulates these steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">resample_kde_percentile</span><span class="p">(</span><span class="n">kde</span><span class="p">):</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">kde</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can generate a sample from the sampling distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t10</span> <span class="o">=</span> <span class="p">[</span><span class="n">resample_kde_percentile</span><span class="p">(</span><span class="n">kde</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>

<span class="n">summary10</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">t10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The following table compares the result to the previous result with bootstrapping.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">summary9</span><span class="p">,</span> <span class="n">summary10</span><span class="p">])</span>
<span class="n">table</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bootstrapping&#39;</span><span class="p">,</span> <span class="s1">&#39;KDE resampling&#39;</span><span class="p">]</span>
<span class="n">table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Estimate</th>
      <th>SE</th>
      <th>CI90</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>bootstrapping</th>
      <td>5155.46</td>
      <td>223.92</td>
      <td>[5107.5, 5107.5]</td>
    </tr>
    <tr>
      <th>KDE resampling</th>
      <td>5103.64</td>
      <td>257.08</td>
      <td>[4687.54, 5537.92]</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The means and standard errors are about the same with either method.
But the confidence interval we get from KDE resampling is sensible.</p>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>There are ten examples in this chapter, so let’s review them:</p>
<ol class="arabic simple">
<li><p>First we used resampling based on a normal model to estimate average family income in the GSS and compute a confidence interval.</p></li>
<li><p>Then we used the same method to estimate the 10th percentile of income, and we found that all of the values in the sampling distribution are negative. The problem is that the normal model does not fit the distribution of income.</p></li>
<li><p>To solve this problem, we switched to bootstrap sampling. First we estimated average family income and confirmed that the results are consistent with the results based on the normal model.</p></li>
<li><p>Then we used bootstrapping to estimate the 10th percentile of income. The results are much more plausible.</p></li>
</ol>
<ol class="arabic simple" start="5">
<li><p>Next we used data from the BRFSS to estimate the average height of men in the U.S.  Since this dataset is large, the confidence interval is very small.  That means that the estimate is precise, in the sense that variability due to random sampling is small, but we don’t know whether it is accurate, because there are other sources of error.</p></li>
<li><p>One of those sources of error is oversampling – that is, some people are more likely to appear in the sample than others.  In the BFRSS, each respondent has a sampling weight that indicates how many people in the population they represent.  We used these weights to do weighted bootstrapping, and found that the error due to oversampling is larger than the variability due to random sampling.</p></li>
<li><p>In one exercise you used weighted bootstrapping to estimate the correlation of height and weight and compute a confidence interval.</p></li>
<li><p>In another exercise you estimated the slope of a regression line and computed a confidence interval.</p></li>
<li><p>Then I demonstrated a problem with bootstrap sampling when the dataset has only a few different values,</p></li>
<li><p>And presented a solution using KDE to smooth the data and draw samples from an estimated distribution.</p></li>
</ol>
<p>In the exercise below, you can work on one more example.
It is a little more involved than the previous exercises, but I will walk you through it.</p>
<p><strong>Exercise:</strong> In Chapter 10 we used logistic regression to model support for legalizing marijuana as a function of age, sex, and education level.
Going back to that example, let’s explore changes in support over time and generate predictions for the next decade.</p>
<p>To prepare the data for logistic regression, we have to recode the <code class="docutils literal notranslate"><span class="pre">grass</span></code> column so <code class="docutils literal notranslate"><span class="pre">1</span></code> means in favor of legalization and <code class="docutils literal notranslate"><span class="pre">0</span></code> means not in favor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gss</span><span class="p">[</span><span class="s1">&#39;grass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gss</span><span class="p">[</span><span class="s1">&#39;grass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">gss</span><span class="p">[</span><span class="s1">&#39;grass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>grass
0.0    25997
1.0    12672
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>As explanatory variables we’ll use <code class="docutils literal notranslate"><span class="pre">year</span></code> and <code class="docutils literal notranslate"><span class="pre">year</span></code> squared, which I’ll store in a column called <code class="docutils literal notranslate"><span class="pre">year2</span></code>.
Subtracting 1990 from <code class="docutils literal notranslate"><span class="pre">year</span></code> before squaring keeps the values of <code class="docutils literal notranslate"><span class="pre">year2</span></code> relatively small, which makes logistic regression work better.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gss</span><span class="p">[</span><span class="s1">&#39;year2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gss</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1990</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can run the model like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>

<span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39;grass ~ year + year2&#39;</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gss</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully.
         Current function value: 0.585064
         Iterations 5
</pre></div>
</div>
</div>
</div>
<p>To generate predictions, I’ll create a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> with a range of values of <code class="docutils literal notranslate"><span class="pre">year</span></code> up to 2030, and corresponding values of <code class="docutils literal notranslate"><span class="pre">year2</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1972</span><span class="p">,</span> <span class="mi">2030</span><span class="p">)</span>
<span class="n">df_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">df_pred</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">years</span>
<span class="n">df_pred</span><span class="p">[</span><span class="s1">&#39;year2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">years</span> <span class="o">-</span> <span class="mi">1990</span><span class="p">)</span> <span class="o">**</span><span class="mi">2</span>

<span class="n">pred</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_pred</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>I’ll use <code class="docutils literal notranslate"><span class="pre">groupby</span></code> to compute the fraction of respondents in favor of legalization during each year.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grass_by_year</span> <span class="o">=</span> <span class="n">gss</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)[</span><span class="s1">&#39;grass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The following function plots the data and decorates the axes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_data</span><span class="p">():</span>
    <span class="n">grass_by_year</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction in favor&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Support for legalization of marijuana&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s what the predictions look like, plotted along with the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;logistic model&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plot_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/abe8e22d57caccbf8a8f47a8c4b678104bba5e5d0c9df4fd7418c7d09edecfde.png" src="_images/abe8e22d57caccbf8a8f47a8c4b678104bba5e5d0c9df4fd7418c7d09edecfde.png" />
</div>
</div>
<p>The model fits past data reasonably well and makes plausible predictions for the next decade, although we can never be sure that trends like this will continue.</p>
<p>This way of representing the results could be misleading because it does not show our uncertainty about the predictions.
Random sampling is just one source of uncertainty among many, and for this kind of prediction it is certainly not the biggest.
But it is the easiest to quantify, so let’s do it, if only as an exercise.</p>
<p>Write a function called <code class="docutils literal notranslate"><span class="pre">bootstrap_regression_line</span></code> that takes a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> as a parameter, uses <code class="docutils literal notranslate"><span class="pre">sample</span></code> to resample the rows, runs the logistic regression model, generates predictions for the rows in <code class="docutils literal notranslate"><span class="pre">df_pred</span></code>, and returns the predictions.</p>
<p>Call this function 101 times and save the results as a list of <code class="docutils literal notranslate"><span class="pre">Series</span></code> objects.
To visualize the results, you have two options:</p>
<ol class="arabic simple">
<li><p>Loop through the list and plot each prediction using a gray line with a low value of <code class="docutils literal notranslate"><span class="pre">alpha</span></code>.  The overlapping lines will form a region showing the range of uncertainty over time.</p></li>
<li><p>Pass the list of <code class="docutils literal notranslate"><span class="pre">Series</span></code> to <code class="docutils literal notranslate"><span class="pre">np.percentile</span></code> with the argument <code class="docutils literal notranslate"><span class="pre">axis=0</span></code> to compute the 5th and 95th percentile in each column.  Plot these percentiles as two lines, or use <code class="docutils literal notranslate"><span class="pre">plt.fill_between</span></code> to plot a shaded region between them.</p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="11_resampling.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Resampling</p>
      </div>
    </a>
    <a class="right-next"
       href="13_hypothesis.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Hypothesis Testing</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-average-income">Estimating Average Income</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-percentiles">Estimating Percentiles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrapping">Bootstrapping</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#working-with-bigger-data">Working with Bigger Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#weighted-bootstrapping">Weighted Bootstrapping</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#correlation-and-regression">Correlation and Regression</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations-of-bootstrapping">Limitations of Bootstrapping</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resampling-with-kde">Resampling with KDE</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Allen B. Downey
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>